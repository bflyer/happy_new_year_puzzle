<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            background-color: #f08080;
        }
        canvas {
            border: 3px solid red;
            border-radius: 30px;
        }
        
    </style>
</head>
<body>
    <!-- canvas {
        /* ?????? */
        border-width: 30px; /* ???????????????? */

        /* ?? border-image ???????? */
        border-image-source: url('border.png'); /* ???????? */
        border-image-slice: 30 fill; /* ???????????????????????? */
        border-image-width: 30px; /* ??????????? */
        border-image-repeat: round; /* ??????????????? round ????? */
    }  -->
    <canvas id="animationCanvas"></canvas>

    <script>
        const canvas = document.getElementById('animationCanvas');
        const ctx = canvas.getContext('2d');

        function img2px() {
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const pixels = [];
            for (let i = 0; i < imageData.data.length; i += 4) {
                if (imageData.data[i + 3] != 0) { // Check opacity
                    pixels.push({
                        x: (i / 4) % canvas.width,
                        y: Math.floor((i / 4) / canvas.width),
                        color: [
                            imageData.data[i],
                            imageData.data[i + 1],
                            imageData.data[i + 2]
                        ]
                    });
                }
            }
            return pixels;
        }

        // Load the image
        const img = new Image();
        img.src = '3.png'; // Replace with your image filename
        img.onload = () => {
            console.log('Image loaded successfully');
            canvas.width = img.width;
            canvas.height = img.height;

            // Draw the image on the canvas
            ctx.drawImage(img, 0, 0);

            // Get pixel data
            // const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const pixels = img2px();
            console.log('Get pixel data successfully');

            // Clear the canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            console.log('Clear canvas successfully');

            // Create Text Image
            const textImg = new Image();
            textImg.src = 'wish.png'; // Replace with your image filename
            textImg.onload = () => {
                console.log('Text image loaded successfully');
                canvas.width = textImg.width;
                canvas.height = textImg.height;

                // Draw the image on the canvas
                ctx.drawImage(textImg, 0, 0);

                const textPixels = img2px();
                console.log('Get text pixel data successfully');

                // Clear the canvas
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                console.log('Clear canvas successfully');

                console.log("textImg: ", textPixels)

                let scatteredPixels = [];

                for (let i = 0; i < pixels.length; i++) {
                    mod_i = i % textPixels.length; 
                    scatteredPixels.push({
                        x: textPixels[mod_i].x,
                        y: textPixels[mod_i].y,
                        color: [
                            pixels[i].color[0],
                            pixels[i].color[1],
                            pixels[i].color[2]
                        ]
                    });
                }

                console.log('Reset scatteredPixels successfully');

                // setTimeout(function() {console.log('Hello, world!');}, 3000); // ÑÓ³Ù3000ºÁÃë£¬¼´3Ãë
                function sleep(milliseconds) {
                    const start = Date.now();
                    while (Date.now() - start < milliseconds);
                }

                for (let i = 0; i < scatteredPixels.length && i < pixels.length; i++) {
                    ctx.fillStyle = `rgb(${scatteredPixels[i].color.join(',')})`;
                    ctx.fillRect(scatteredPixels[i].x, scatteredPixels[i].y, 1, 1);
                }

                // Reconstruct
                function reconstructText() {
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    console.log("scatteredPixels: ", scatteredPixels)
                    for (let i = 0; i < scatteredPixels.length && i < pixels.length; i++) {
                        scatteredPixels[i].x += (pixels[i].x - scatteredPixels[i].x) * 0.05; // Ease towards target
                        scatteredPixels[i].y += (pixels[i].y - scatteredPixels[i].y) * 0.05; // Ease towards target
                        ctx.fillStyle = `rgb(${scatteredPixels[i].color.join(',')})`;
                        ctx.fillRect(scatteredPixels[i].x, scatteredPixels[i].y, 1, 1);
                    }

                    requestAnimationFrame(reconstructText);
                }

                // Start animation
                requestAnimationFrame(reconstructText);
            };
        }
        img.onerror = () => {
            console.error('Failed to load image');
        };
    </script>
</body>
</html>